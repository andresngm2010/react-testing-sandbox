<!doctype html>
<meta charset="utf-8" />
<title>Child (cross-origin)</title>
<style>
  body { font-family: system-ui; margin: 12px; }
  .ok { color: #0a0; }
  .muted { color: #555; }
  button { padding: 6px 10px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
</style>

<h1 style="margin:0 0 8px 0;">Child listo ‚úÖ (cross-origin)</h1>

<div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
  <button id="changeBtn" data-testid="child-change">Cambiar texto</button>
  <button id="resetBtn" data-testid="child-reset">Reset</button>
</div>

<!-- Texto que se modificar√° y que las herramientas pueden validar -->
<div id="last" data-testid="child-status" role="status" aria-live="polite" class="muted">
  Estado: INICIAL
</div>

<script>
  // ‚ö†Ô∏è Ajusta si el padre NO est√° en http://localhost:5173
  const PARENT_ORIGIN = "http://localhost:5173";

  const lastEl = document.getElementById("last");
  const changeBtn = document.getElementById("changeBtn");
  const resetBtn  = document.getElementById("resetBtn");

  function setStatus(text, cls = "ok") {
    lastEl.textContent = text;
    lastEl.className = cls;
    // Notificar al padre (si existe) para validaci√≥n desde fuera del iframe
    if (window.parent) {
      window.parent.postMessage({ type: "TEXT_CHANGED", text, at: Date.now() }, PARENT_ORIGIN);
    }
  }

  changeBtn.addEventListener("click", () => {
    const t = new Date().toLocaleTimeString();
    setStatus(`Estado: CAMBIADO por click (${t})`, "ok");
  });

  resetBtn.addEventListener("click", () => {
    setStatus("Estado: INICIAL", "muted");
  });

  // Escuchar mensajes del padre (por si quieres activar el cambio sin tocar el DOM interno)
  window.addEventListener("message", (event) => {
    // üîê Seguridad: aceptar SOLO del origen del padre esperado
    if (event.origin !== PARENT_ORIGIN) return;

    const msg = event.data || {};
    if (msg.type === "PING") {
      // Responder al handshake original
      event.source.postMessage({ type: "PONG", at: Date.now() }, event.origin);
      return;
    }
    if (msg.type === "CHANGE_TEXT") {
      const t = msg.text || `Estado: CAMBIADO por postMessage (${new Date().toLocaleTimeString()})`;
      setStatus(t, "ok");
      // Confirmaci√≥n expl√≠cita
      event.source.postMessage({ type: "TEXT_CHANGED_ACK", text: t, at: Date.now() }, event.origin);
      return;
    }
    if (msg.type === "RESET_TEXT") {
      setStatus("Estado: INICIAL", "muted");
      event.source.postMessage({ type: "TEXT_RESET_ACK", at: Date.now() }, event.origin);
      return;
    }
  });
</script>
